---
title: "movement_patterns"
format: html
editor: visual
execute: 
  cache: TRUE
---

```{r}
#| label: load-packages
#| include: false

library(tidyverse)
library(sf)
library(terra)
library(here)
```

```{r}
#| label: load-data
#| include: false

musk_collar <- readRDS(here("data/processed/musk_collar_filt.rds"))
lc_2010_proj <- rast(here("data/processed/lc_2010_proj.tif"))
```


## Movement Trends

```{r, fig.height=6, fig.width=8}
#| label: dist_time
#| dependson: "load-data"
#| echo: FALSE
#| warning: FALSE

musk_collar %>%
  ## add one to distances to allow 0s to be plotted on log scale
  mutate(steplength_m = steplength_m + 1,
         Season = case_when(
           between(month, 3, 5) ~ "Spring",
           between(month, 6, 8) ~ "Summer",
           between(month, 9, 11) ~ "Autumn",
           TRUE ~ "Winter"),
         Season = factor(Season,
                         levels = c("Winter", "Spring",
                                    "Summer", "Autumn"))
    ) %>%
  ggplot(aes(x = datetime, y = steplength_m)) +
  geom_point(aes(colour = Season), size = 0.5) +
  geom_smooth(method = "loess", span = 0.25, alpha = 0.5) +
  scale_y_log10() +
  facet_wrap(~Id_Number, scales = "free_x") +
  scale_colour_manual(values = c("lightblue3","springgreen","yellow2","orange")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

Based on the step length time series above, movement distances tend to be highest in the summer (June, July, August), gradually decrease during autumn (September, October, November) and winter (December, January, February) and experience a sharp increase in the late spring (May). Perhaps this increase is timed with parturition, which has been found to start in April/May (Adamczewski 1997). Alternatively, this could be tied to the timing of snowmelt. We can explore this further by looking at average seasonal step lengths for each muskox:

```{r}
#| label: dist_seas
#| dependson: "fix_data"
#| echo: FALSE
#| warning: FALSE

musk_season <- musk_collar_fix %>%
  ## add one to distances to allow 0s to be plotted on log scale
  mutate(steplength_m = steplength_m + 1,
         Season = case_when(
           between(month, 3, 5) ~ "Spring",
           between(month, 6, 8) ~ "Summer",
           between(month, 9, 11) ~ "Autumn",
           TRUE ~ "Winter"),
         Season = factor(Season,
                         levels = c("Winter", "Spring",
                                    "Summer", "Autumn"))
    )
musk_season %>%
  sf::st_drop_geometry() %>%
  ggplot(aes(x = Season, y = steplength_m, fill = Id_Number)) +
  geom_boxplot() +
  scale_y_log10() +
  theme_bw()
```

Step lengths in the winter and spring are similar, whereas autumn step lengths are intermediate between winter and summer. This again highlights the discrepancy between the gradual decrease in step lengths from summer to winter compared with the sharper increase from winter to summer.

For the most part, average seasonal step lengths are consistent between muskoxen, though there appear to be greater variation in the spring and autumn. To examine this further, let's plot smoothed curves of step lengths against day of year for different years. We'll restrict this plot to muskoxen-year combinations with more than half a year's worth of data:

```{r, fig.height=6, fig.width=8}
#| label: dist_years
#| dependson: "dist_seas"
#| echo: FALSE
#| warning: FALSE

musk_season %>%
  mutate(yday = yday(datetime)
    ) %>%
  group_by(Id_Number, year) %>%
  filter(year %in% 2008:2011, n() > 365/2*3) %>%
  ggplot(aes(x = yday, y = steplength_m, linetype = Id_Number,
             colour = factor(year))) +
  geom_smooth(method = "loess", se = FALSE) +
  scale_y_log10() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.key.width = unit(2,"cm"))
```

The greatest variation in step lengths appears to occur in the early spring. The curves of step lengths follow similar trajectories within the same year and variation in step lengths across years appears to be greater than variation in step lengths across muskoxen. In particular, step lengths from the late winter and early spring of 2011 are considerably shorter than those from the same time during other years.

We can also look at net squared displacement curves to investigate movement patterns of muskoxen (i.e. resident, migratory, or nomadic).

```{r}
#| label: nsd
#| dependson: "dist_seas"
#| 
```

## Spatial Patterns

```{r fig.height=6, fig.width=10}
#| label: spat-plot
#| dependson: dist_seas
#| echo: FALSE
#| warning: FALSE

lc_2010_proj <- rast(here("data/processed/lc_2010_proj.tif"))
nwt_names <-sf::st_read(here("data/raw/nwt_names/cgn_nt_shp_eng.shp"),
                         quiet = TRUE) %>%
  sf::st_transform(4326) %>%
  sf::st_crop(lc_2010_proj) %>%
  filter(GENERIC == "Town")

musk_season %>%
  ggplot() +
  tidyterra::geom_spatraster(data = lc_2010_proj) +
  geom_sf(aes(colour = Id_Number), shape = 21, stroke = 1,
          fill = "white", alpha = 0.5) +  
  geom_sf(data = nwt_names, size = 4, 
          fill = "white", shape = 21,
          stroke = 2) +
  geom_sf_label(data = nwt_names, aes(label = GEONAME),
                nudge_y = -0.08) +
  theme_bw(10) +
  theme(legend.box = "horizontal")


```
