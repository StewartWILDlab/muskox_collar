---
title: "Muskox Movement Patterns"
format: html
editor: visual
execute: 
  cache: TRUE
---

```{r}
#| label: load-packages
#| include: false

library(tidyverse)
library(sf)
library(terra)
library(here)
```

```{r}
#| label: load-data
#| include: false

musk_collar_filt <- readRDS(here("data/processed/musk_collar_filt.rds"))
lc_2010_proj <- rast(here("data/processed/lc_2010_proj.tif"))
```

In this document, we will examine patterns in the movement behaviours of collared muskoxen. We will use muskox speed and turning angles to explore behaviour.

## Movement Trends

```{r, fig.height=6, fig.width=8}
#| label: dist_time
#| dependson: "load-data"
#| echo: FALSE
#| warning: FALSE

musk_collar_filt %>%
  mutate(Season = case_when(
           between(month, 3, 5) ~ "Spring",
           between(month, 6, 8) ~ "Summer",
           between(month, 9, 11) ~ "Autumn",
           TRUE ~ "Winter"),
         Season = factor(Season,
                         levels = c("Winter", "Spring",
                                    "Summer", "Autumn"))
    ) %>%
  ggplot(aes(x = datetime, y = pSpeed*1000+1)) +
  geom_point(aes(colour = Season), size = 0.5) +
  geom_smooth(method = "loess", span = 0.25, alpha = 0.5) +
  scale_y_log10() +
  ylab("Speed (m/h)") +
  facet_wrap(~Id_Number, scales = "free_x") +
  scale_colour_manual(values = c("lightblue3","springgreen","yellow2","orange")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

Based on the time series above, movement tends to be highest in the summer (June, July, August), gradually decrease during autumn (September, October, November) and winter (December, January, February) and experience a sharp increase in the late spring (May). Perhaps this increase is timed with parturition, which has been found to start in April/May (Adamczewski 1997). Alternatively, this could be tied to the timing of snowmelt. We can explore this further by looking at average seasonal step lengths for each muskox:

```{r}
#| label: dist_seas
#| dependson: "fix_data"
#| echo: FALSE
#| warning: FALSE

musk_season <- musk_collar_filt %>%
  ## add one to distances to allow 0s to be plotted on log scale
  mutate(Season = case_when(
           between(month, 3, 5) ~ "Spring",
           between(month, 6, 8) ~ "Summer",
           between(month, 9, 11) ~ "Autumn",
           TRUE ~ "Winter"),
         Season = factor(Season,
                         levels = c("Winter", "Spring",
                                    "Summer", "Autumn"))
    )
musk_season %>%
  sf::st_drop_geometry() %>%
  ggplot(aes(x = Season, y = pSpeed*1000+1, fill = Id_Number)) +
  geom_boxplot() +
  ylab("Speed (m/h)") +
  scale_y_log10() +
  theme_bw()
```

Step lengths in the winter and spring are similar, whereas autumn step lengths are intermediate between winter and summer. This again highlights the discrepancy between the gradual decrease in step lengths from summer to winter compared with the sharper increase from winter to summer.

For the most part, average seasonal step lengths are consistent between muskoxen, though there appear to be greater variation in the spring and autumn. To examine this further, let's plot smoothed curves of step lengths against day of year for different years. We'll restrict this plot to muskoxen-year combinations with more than half a year's worth of data:

```{r, fig.height=6, fig.width=8}
#| label: dist_years
#| dependson: "dist_seas"
#| echo: FALSE
#| warning: FALSE

musk_season %>%
  mutate(yday = yday(datetime)
    ) %>%
  group_by(Id_Number, year) %>%
  filter(year %in% 2008:2011, n() > 365/2*3) %>%
  ggplot(aes(x = yday, y = pSpeed*1000+1, linetype = Id_Number,
             colour = factor(year))) +
  geom_smooth(method = "loess", se = FALSE) +
  ylab("Speed (m/h)") +
  scale_y_log10() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.key.width = unit(2,"cm"))
```

The greatest variation in step lengths appears to occur in the early spring. The curves of step lengths follow similar trajectories within the same year and variation in step lengths across years appears to be greater than variation in step lengths across muskoxen. In particular, step lengths from the late winter and early spring of 2011 are considerably shorter than those from the same time during other years.

Movement patterns in spring may be related to calving. Previous studies in Greenland have shown that muskoxen benefit from earlier spring green-up (Eikelenboom et al., 2021), so muskoxen may be able to alter their movement behaviour depending on green-up timing. In 2008 and 2009, surveys were flown to relocate collared muskoxen to see if they were accompanied by calves. We can plot these data on graphs of step lengths in the early spring to investigate how approximate calving dates impact movement. 

```{r, fig.height=6, fig.width=8}
#| label: dist_calf
#| dependson: "dist_seas"
#| echo: FALSE
#| warning: FALSE

musk_calf <- read_csv(here("data/raw/muskox_data/musk_calf_surveys.csv"), show_col_types = FALSE) %>%
  mutate(Id_Number = as.factor(Id_Number),
         year = lubridate::year(Date)) %>%
  arrange(Date) %>%
  select(Id_Number, year, Date, with_calf)

temp <- musk_season %>%
  mutate(yday = yday(datetime)) %>%
  group_by(Id_Number, year) %>%
  filter(month %in% 4:6, pTime == 8, year %in% 2008:2009) %>%
  filter(n()>25*3) %>%
  left_join(musk_calf, by = c("Id_Number", "year")) %>%
  group_by(Id_Number, datetime) %>%
  filter(datetime > Date & )
  ggplot(aes(x = yday, y = pDist)) +
  geom_line() +
  facet_wrap(~year+Id_Number) +
  scale_y_log10() +
  ylab("Step length (km)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.key.width = unit(2,"cm"))
```
```


## Net Squared Displacement

We can also look at net squared displacement curves to investigate movement patterns of muskoxen (i.e. resident, migratory, or nomadic). See Bunnefeld et al. (2011) for examples of how these curves look for different movement classes (i.e. migrant, disperser, resident, nomad).

To do this we will use the **adehabitatLT** package to format our data and the **migrateR** package to fit different models to the net displacement data. Let's first get our collar data into the trajectory format used by adehabitatLT. We will also subset our data to one observation per day to improve modelling efficiency. 

```{r, fig.height=6, fig.width=8}
#| label: musk_ltraj
#| dependson: "load-data"
#| echo: TRUE
#| warning: FALSE

musk_collar_sub <- musk_collar_filt %>%
  filter(lubridate::hour(datetime) == 16)

xy <- musk_collar_sub %>%
  sf::st_transform("+proj=utm +zone=9") %>%
  sf::st_coordinates()
ltraj <- adehabitatLT::as.ltraj(xy = xy, date = musk_collar_sub$datetime, id = musk_collar_sub$Id_Number)

ld(ltraj) %>%
  ggplot(aes(x = date, y = R2n)) +
  geom_point(size = 0.5) +
  geom_line() +
  ylab("Net squared displacement (km^2)") +
  facet_wrap(~id, scales = "free") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

The plot above shows the net squared displacement from the initial location for each collared muskoxen. There does not appear to be a clear movement behaviiour shared between all muskoxen. Most appear to have short periods of time during the summer with large net squared displacement, but these are generally followed by longer periods where net squared displacement is much smaller. Muskoxen 7011 and 7012 show a general increasing trend in net squared displacement, but there are still extended periods of smaller displacement throughout the time series. Most of the periods of larger displacement do not appear to be long enough to represent a separate summer range. Examinations of animations of muskox movements generally show that they tend to move between patches of resources during the summer rather than sticking to one specific area. 

To model movement behaviours in the **migrateR** package, we first need to split up these time series into different bursts that represent approximately a years worth of data. Large gaps and time series that are longer or much shorter than a year can make movement models difficult to fit. To deal with gaps in the trajectories, we can plot the number of days between successive observations:

```{r, fig.height=10, fig.width=8}
#| label: plot_dt
#| dependson: "musk_ltraj"
#| echo: FALSE
#| warning: FALSE
 
adehabitatLT::plotltr(ltraj, "dt/3600/24")
```

We can see there are a few instances where the gap between successive observations exceeds 10 days. Let's split the time series into different bursts for each collared animal. 


```{r, fig.height=10, fig.width=8}
#| label: ltraj_burst
#| dependson: "ltraj"
#| echo: FALSE
#| warning: FALSE

### split trajectories when number of days between points is >10 days
ltraj_burst <- adehabitatLT::cutltraj(ltraj, "dt> (10*3600*24)", 
                        nextr = TRUE)
musk_burst <- adehabitatLT::ld(ltraj_burst) %>%
  group_by(burst) %>%
  ## split bursts by years of data
  mutate(day = (date - min(date))/(3600*24),
         burst = case_when(
           day <= 365 ~ str_c(burst,0),
           day <= 365*2 ~ str_c(burst,1),
           day <= 365*3 ~ str_c(burst,2),
           day <= 365*4 ~ str_c(burst,3)
         )) %>%
  ## remove bursts with less than 10 days of data
  filter(n() > 100) %>%
  as.data.frame()

ltraj_burst <- adehabitatLT::dl(musk_burst)  

ltraj_burst

```

We now have trajectories for 7 collared muskoxen split across 16 bursts. We will now use the **migrateR** package to fit a set of pre-defined movement models to each burst. 

```{r, fig.height=3}
#| label: nsd_mod
#| dependson: "ltraj_burst"
#| echo: FALSE
#| warning: FALSE

library(adehabitatLT)
rloc <- migrateR::findrloc(ltraj_burst)
nsd_mod <- migrateR::mvmtClass(ltraj_burst, rloc = rloc$rloc)
migrateR::plot.mvmts(nsd_mod)
```





## Spatial Patterns

```{r fig.height=6, fig.width=10}
#| label: spat-plot
#| dependson: dist_seas
#| echo: FALSE
#| warning: FALSE

lc_2010_proj <- rast(here("data/processed/lc_2010_proj.tif"))
nwt_names <-sf::st_read(here("data/raw/nwt_names/cgn_nt_shp_eng.shp"),
                         quiet = TRUE) %>%
  sf::st_transform(4326) %>%
  sf::st_crop(lc_2010_proj) %>%
  filter(GENERIC == "Town")

musk_season %>%
  ggplot() +
  tidyterra::geom_spatraster(data = lc_2010_proj) +
  geom_sf(aes(colour = Id_Number), shape = 21, stroke = 1,
          fill = "white", alpha = 0.5) +  
  geom_sf(data = nwt_names, size = 4, 
          fill = "white", shape = 21,
          stroke = 2) +
  geom_sf_label(data = nwt_names, aes(label = GEONAME),
                nudge_y = -0.08) +
  theme_bw(10) +
  theme(legend.box = "horizontal")


```
